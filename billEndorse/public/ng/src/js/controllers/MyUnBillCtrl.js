/** * Created by felixjin on 2016/12/4. */app.controller('MyUnBillCtrl', ['$scope','$localStorage','$state','HttpService','REST_URL','$modal','DialogService','$q', function($scope, $localStorage, $state,HttpService,REST_URL,$modal,DialogService,$q) {    $scope.rowCollectionPage = [];    //  pagination    $scope.itemsByPage=1;    function render() {        if($localStorage.loginuser) {            var data = {                name: $localStorage.loginuser.name,                cmId: $localStorage.loginuser.cmId,                Acct: $localStorage.loginuser.Acct            }        }else {            $state.go('access.signin');        }        HttpService.post(REST_URL.query, {fcn: "queryMyWaitBill", args:[$localStorage.loginuser.cmId]}).then(function (response) {            $scope.rowCollectionPage = JSON.parse(response.data.message);            $scope.loginuser = $localStorage.loginuser;            if (!$scope.$$phase) {                $scope.$apply();            }        });    }    render();    $scope.view = function (billNo) {        // alert(billNo);        var data = {            name: $localStorage.loginuser.name,            cmId: $localStorage.loginuser.cmId,            Acct: $localStorage.loginuser.Acct,            billNo: billNo        }        HttpService.post(REST_URL.query, {fcn: "queryByBillNo", args:[billNo.BillInfoID]}).then(function (response) {            var bill = JSON.parse(response.data.message);            $scope.item = bill;            $scope.item.historyList = bill.History;            if (!$scope.$$phase) {                $scope.$apply();            }            open (billNo);        });    }    function open (billNo) {        var modalInstance = $modal.open({            templateUrl: 'myUnBillInfo.html',            controller: 'MyUnBillModalInstanceCtrl',            size: 'lg',            resolve: {                item: function () {                    return $scope.item;                }            }        });        modalInstance.result.then(function (selected) {            // endr request            var data = {                billNo: billNo,                name: $localStorage.loginuser.name,                cmId: $localStorage.loginuser.cmId,                Acct: $localStorage.loginuser.Acct,                action: selected.action            }            var actionStr = '已';            var fcn = '';            if (selected.action == 'SU00') {                actionStr = '已签收';                fcn = 'accept';            }else if (selected.action == 'SU01') {                actionStr = '已拒绝';                fcn = 'reject';            }            HttpService.post(REST_URL.invoke, {fcn: fcn, args:[billNo.BillInfoID, $localStorage.loginuser.cmId, $localStorage.loginuser.Acct]}).then(function (response) {                DialogService.open('infoDialog', {                    scope: $scope,                    title: actionStr+'成功',                    message: response.data.message,                    onOk: function (value) {                    },                    onCancel: function (value) {                        // do nothing                    }                });            });        }, function () {            console.log('Modal dismissed at: ' + new Date());        });    };}]);app.controller('MyUnBillModalInstanceCtrl', ['$scope', '$modalInstance', 'item', function ($scope, $modalInstance, item) {    $scope.item = item;    $scope.historyList = item.historyList;    $scope.itemsByPage = 10;    $scope.selected = {        item: $scope.item    };    $scope.ok = function (action) {        $scope.selected.action = action;        $modalInstance.close($scope.selected);    };    $scope.cancel = function () {        $modalInstance.dismiss('cancel');    };}]);